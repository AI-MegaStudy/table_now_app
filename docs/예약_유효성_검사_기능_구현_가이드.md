# 예약 유효성 검사 기능 구현 가이드

**작성일**: 2026-01-22  
**작성자**: AI Assistant  
**대상**: 예약 페이지 담당 개발자

---

## 1. 개요

예약 프로세스에서 발생할 수 있는 중복 예약 및 잘못된 입력을 방지하기 위한 유효성 검사 기능을 구현했습니다.

### 구현된 기능

| 기능 | 적용 위치 | 설명 |
|------|-----------|------|
| 동일 인물 동일 시간 예약 방지 | ReservePage01 | 같은 고객이 같은 시간에 중복 예약 불가 |
| 예약된 테이블 선택 방지 | ReservePage02 | 이미 예약된 테이블 선택 시 경고 |
| 필수 입력 누락 경고 | ReservePage01, 02 | 필수 항목 미입력 시 스낵바 경고 |

---

## 2. 파일 구조

```
lib/
├── utils/
│   └── reservation_validator.dart    # [신규] 유효성 검사 유틸리티
├── theme/
│   ├── common_color_scheme.dart      # [수정] stepActive, stepInactive 추가
│   ├── table_now_color_scheme.dart   # [수정] stepActive, stepInactive 추가
│   ├── app_color_scheme.dart         # [수정] stepActive, stepInactive getter 추가
│   └── app_colors.dart               # [수정] 스텝 인디케이터 색상 값 정의
├── vm/
│   └── reserve_page01_notifier.dart  # [수정] customerReservations 추가
└── view/
    └── reservepage/
        ├── reserve_page01.dart       # [수정] 시간 선택 검증, 스낵바, 스텝 색상 추가
        └── reserve_page02.dart       # [수정] 테이블 선택 검증, 스낵바, 스텝 색상 추가

fastapi/
└── app/
    └── api/
        └── reserve.py                # [수정] 예약 조회 쿼리 버그 수정
```

---

## 3. 신규 파일: ReservationValidator

### 파일 위치
`lib/utils/reservation_validator.dart`

### 주요 메서드

#### 3.1 hasCustomerReservation()
해당 고객이 특정 날짜/시간에 이미 예약이 있는지 확인

```dart
static bool hasCustomerReservation({
  required Map<String, List<String>> customerReservations,
  required String date,
  required String time,
})
```

**파라미터:**
- `customerReservations`: 고객의 예약 목록 (Map<날짜, List<시간>>)
- `date`: 확인할 날짜 (예: '2025-01-15')
- `time`: 확인할 시간 (예: '12:00')

**반환값:** 이미 예약이 있으면 `true`

**사용 예시:**
```dart
final hasReservation = ReservationValidator.hasCustomerReservation(
  customerReservations: data.customerReservations,
  date: '2025-01-15',
  time: '12:00',
);

if (hasReservation) {
  CustomCommonUtil.showErrorSnackbar(
    context: context,
    message: '이미 해당 시간에 예약이 있습니다.',
  );
}
```

---

#### 3.2 isTableReserved()
해당 시간에 테이블이 이미 예약되었는지 확인

```dart
static bool isTableReserved({
  required Map<String, dynamic> tablesData,
  required String date,
  required String time,
  required String tableSeq,
})
```

**파라미터:**
- `tablesData`: 전체 예약 데이터 (Map<날짜, Map<시간, Map<테이블seq, 정보>>>)
- `date`: 확인할 날짜
- `time`: 확인할 시간
- `tableSeq`: 확인할 테이블 시퀀스

**반환값:** 이미 예약되었으면 `true`

---

#### 3.3 getReservedTableSeqs()
해당 시간에 예약된 테이블 목록 반환

```dart
static List<String> getReservedTableSeqs({
  required Map<String, dynamic> tablesData,
  required String date,
  required String time,
})
```

---

#### 3.4 getCustomerReservedTimes()
고객의 예약 목록에서 특정 날짜의 예약 시간들 반환

```dart
static List<String> getCustomerReservedTimes({
  required Map<String, List<String>> customerReservations,
  required String date,
})
```

---

## 4. 수정된 파일 상세

### 4.1 reserve_page01_notifier.dart

#### 변경 사항
`ReservePage01State`에 `customerReservations` 필드 추가

```dart
class ReservePage01State {
  // ... 기존 필드들 ...
  
  /// 현재 고객의 예약 정보 (날짜 -> 시간 리스트)
  /// 동일 인물의 동일 시간 예약 방지에 사용
  final Map<String, List<String>> customerReservations;
  
  // ...
}
```

#### fetchData() 수정 내용
예약 데이터 파싱 시 현재 고객의 예약만 별도로 저장

```dart
// 현재 고객의 예약 정보 (동일 인물 동일 시간 예약 방지용)
// {'2025-01-15': ['12:00', '14:00']} 형식
Map<String, List<String>> customerReservationsMap = {};

for (int i = 0; i < reserveData.length; i++) {
  final reserve = reserveData[i];
  // ...
  
  // 현재 고객의 예약인 경우 customerReservationsMap에 추가
  if (reserve.customer_seq == cseq) {
    customerReservationsMap.putIfAbsent(rdate, () => []);
    if (!customerReservationsMap[rdate]!.contains(rtime)) {
      customerReservationsMap[rdate]!.add(rtime);
    }
  }
  // ...
}
```

---

### 4.2 reserve_page01.dart

#### 추가된 import
```dart
import 'package:table_now_app/utils/reservation_validator.dart';
```

#### 시간 선택 GridView 수정

**변경 전:**
```dart
GestureDetector(
  onTap: () {
    ref.read(reservePage01NotifierProvider.notifier).selectTime(time);
  },
  // ...
)
```

**변경 후:**
```dart
// 현재 선택된 날짜에서 이 시간에 이미 예약이 있는지 확인
final dateKey = data.selectedDay?.toString().substring(0, 10) ?? '';
final bool hasExistingReservation = ReservationValidator.hasCustomerReservation(
  customerReservations: data.customerReservations,
  date: dateKey,
  time: time,
);

GestureDetector(
  onTap: () {
    if (hasExistingReservation) {
      CustomCommonUtil.showErrorSnackbar(
        context: context,
        message: '이미 해당 시간에 예약이 있습니다.',
      );
      return;
    }
    ref.read(reservePage01NotifierProvider.notifier).selectTime(time);
  },
  child: Container(
    decoration: BoxDecoration(
      color: hasExistingReservation
          ? Colors.grey.shade300
          : selected ? p.primary : p.cardBackground,
      // ...
    ),
    child: Column(
      children: [
        Text(time, /* ... */),
        if (hasExistingReservation)
          Text('예약됨', style: /* ... */),
      ],
    ),
  ),
)
```

#### 필수 입력 검증 추가 (다음 버튼)

```dart
onPressed: () {
  // 유효성 검사
  if (nameController.text.trim().isEmpty) {
    CustomCommonUtil.showErrorSnackbar(
      context: context,
      message: '이름을 입력해주세요.',
    );
    return;
  }
  if (phoneController.text.trim().isEmpty) {
    CustomCommonUtil.showErrorSnackbar(
      context: context,
      message: '연락처를 입력해주세요.',
    );
    return;
  }
  if (numberController.text.trim().isEmpty) {
    CustomCommonUtil.showErrorSnackbar(
      context: context,
      message: '인원을 입력해주세요.',
    );
    return;
  }
  if (data.selectedDay == null) {
    CustomCommonUtil.showErrorSnackbar(
      context: context,
      message: '날짜를 선택해주세요.',
    );
    return;
  }
  if (data.selectedTime == null) {
    CustomCommonUtil.showErrorSnackbar(
      context: context,
      message: '시간을 선택해주세요.',
    );
    return;
  }
  
  // ... 다음 페이지로 이동 ...
}
```

---

### 4.3 reserve_page02.dart

#### TableItem 위젯 수정

**추가된 속성:**
```dart
class TableItem extends StatelessWidget {
  // ... 기존 속성들 ...
  
  /// 예약된 테이블 클릭 시 호출되는 콜백 (피드백 제공용)
  final VoidCallback? onReservedTap;
  
  // ...
}
```

**build() 메서드 수정:**
```dart
return GestureDetector(
  onTap: isReserved ? onReservedTap : onTap,  // 예약된 테이블도 탭 가능
  child: Container(
    // ...
    child: Column(
      children: [
        Text(name, /* ... */),
        Text(
          isReserved ? '예약됨' : '$capacity인',  // 예약된 테이블에 라벨 표시
          // ...
        ),
      ],
    ),
  ),
);
```

#### TableItem 사용 시 콜백 추가

```dart
return TableItem(
  name: tableName,
  capacity: capacity,
  isReserved: isReserved,
  isSelected: isSelected,
  onTap: () {
    final int left = reserve_capacity - state.usedCapacity!;

    // 선택하려는데 인원 부족하면 차단
    if (!isSelected && left <= 0) {
      CustomCommonUtil.showErrorSnackbar(
        context: context,
        message: '선택 가능한 인원을 초과했습니다.',
      );
      return;
    }
    // ... 테이블 선택 로직 ...
  },
  onReservedTap: () {
    CustomCommonUtil.showErrorSnackbar(
      context: context,
      message: '이미 예약된 테이블입니다.',
    );
  },
);
```

#### 다음 버튼 검증 추가

```dart
onPressed: () {
  // 유효성 검사
  if (state.selectedTable == null || state.selectedTable!.isEmpty) {
    CustomCommonUtil.showErrorSnackbar(
      context: context,
      message: '테이블을 선택해주세요.',
    );
    return;
  }
  // ... 다음 페이지로 이동 ...
}
```

---

## 5. UI 변경 사항

### 5.1 시간 선택 (ReservePage01)

| 상태 | 배경색 | 텍스트 | 추가 라벨 |
|------|--------|--------|-----------|
| 기본 | cardBackground | textPrimary | - |
| 선택됨 | primary | textOnPrimary | - |
| 이미 예약됨 | grey.shade300 | grey.shade600 | "예약됨" |

### 5.2 테이블 선택 (ReservePage02)

| 상태 | 배경색 | 텍스트 | 하단 라벨 |
|------|--------|--------|-----------|
| 선택 가능 | Colors.green | white | "N인" |
| 선택됨 | primary | white | "N인" |
| 이미 예약됨 | divider | grey.shade600 | "예약됨" |

---

## 6. 스낵바 메시지 목록

| 위치 | 조건 | 메시지 |
|------|------|--------|
| ReservePage01 | 이름 미입력 | "이름을 입력해주세요." |
| ReservePage01 | 연락처 미입력 | "연락처를 입력해주세요." |
| ReservePage01 | 인원 미입력 | "인원을 입력해주세요." |
| ReservePage01 | 날짜 미선택 | "날짜를 선택해주세요." |
| ReservePage01 | 시간 미선택 | "시간을 선택해주세요." |
| ReservePage01 | 이미 예약된 시간 클릭 | "이미 해당 시간에 예약이 있습니다." |
| ReservePage02 | 테이블 미선택 | "테이블을 선택해주세요." |
| ReservePage02 | 예약된 테이블 클릭 | "이미 예약된 테이블입니다." |
| ReservePage02 | 인원 초과 | "선택 가능한 인원을 초과했습니다." |

---

## 7. 테스트 시나리오

### 7.1 동일 인물 동일 시간 예약 방지 테스트

1. 고객 A로 로그인
2. 매장 선택 후 예약 페이지 진입
3. 날짜 선택
4. **이미 예약한 시간이 회색으로 표시되고 "예약됨" 라벨 확인**
5. 해당 시간 클릭 시 스낵바 경고 확인

### 7.2 예약된 테이블 선택 방지 테스트

1. 예약 페이지 1단계 완료 후 테이블 선택 페이지 진입
2. **이미 예약된 테이블이 회색으로 표시되고 "예약됨" 라벨 확인**
3. 해당 테이블 클릭 시 스낵바 경고 확인

### 7.3 필수 입력 검증 테스트

1. 예약 페이지 진입
2. 아무것도 입력하지 않고 "다음" 버튼 클릭
3. **순서대로 누락된 항목에 대한 스낵바 경고 확인**

---

## 8. 주의사항

1. **customerReservations 데이터는 fetchData() 호출 시 생성됩니다.**
   - 페이지 진입 시 반드시 fetchData()가 호출되어야 합니다.

2. **예약된 시간/테이블 체크는 클라이언트 측 검증입니다.**
   - 서버 측에서도 중복 예약 방지 로직이 필요할 수 있습니다.

3. **CustomCommonUtil.showErrorSnackbar() 사용**
   - 기존 프로젝트의 공통 스낵바 유틸을 사용합니다.

---

## 9. 백엔드 API 버그 수정

### 문제
예약 조회 API에서 `created_at`(예약 생성일) 기준으로 필터링하여, 
며칠 전에 생성한 미래 예약이 조회되지 않는 버그가 있었습니다.

### 수정 파일
`fastapi/app/api/reserve.py`

### 변경 내용

**변경 전 (Line 100, 149):**
```python
WHERE created_at BETWEEN %s AND %s
```

**변경 후:**
```python
WHERE reserve_date BETWEEN %s AND %s
```

### 영향받는 API

| API | 설명 |
|-----|------|
| `/reserve/select_reserves_8/{date}` | 8일간 전체 예약 조회 |
| `/reserve/select_reserves_8_store/{date}/{seq}` | 8일간 특정 매장 예약 조회 |

### 주의사항
- **FastAPI 서버 재시작 필요** - 코드 수정 후 서버를 재시작해야 변경 사항이 적용됩니다.

---

## 10. 스텝 인디케이터 테마 색상 추가

### 추가된 테마 색상

| 색상명 | 라이트 모드 | 다크 모드 | 설명 |
|--------|-------------|-----------|------|
| `stepActive` | `#2E7D32` (진한 초록) | `#66BB6A` (밝은 초록) | 스텝 활성/완료 상태 |
| `stepInactive` | `#E8D5C4` (연한 베이지) | `#4A3A2A` (다크 갈색) | 스텝 비활성 상태 |

### 수정된 파일

| 파일 | 변경 내용 |
|------|-----------|
| `lib/theme/common_color_scheme.dart` | `stepActive`, `stepInactive` 필드 추가 |
| `lib/theme/table_now_color_scheme.dart` | `stepActive`, `stepInactive` 필드 추가 |
| `lib/theme/app_color_scheme.dart` | `stepActive`, `stepInactive` getter 추가 |
| `lib/theme/app_colors.dart` | 라이트/다크 테마별 색상 값 정의 |

### 사용 방법

```dart
final p = context.palette;

// 스텝 인디케이터에서 사용
backgroundColor: isActive || isCompleted ? p.stepActive : p.stepInactive,
color: isActive ? p.stepActive : p.textSecondary,
```

---

## 11. 향후 개선 사항

- [ ] 서버 측 중복 예약 방지 API 추가
- [ ] 예약 취소 시 customerReservations 실시간 업데이트
- [ ] 예약된 테이블 시각적 구분 강화 (아이콘 추가 등)

---

## 12. 문의

구현 관련 문의사항이 있으시면 연락 주세요.
